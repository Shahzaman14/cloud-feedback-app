<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Cloud Feedback System</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <h2>üöÄ Cloud Feedback System</h2>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html">Home</a></li>
                <li><a href="submit.html">Submit Feedback</a></li>
                <li><a href="dashboard.html" class="active">Dashboard</a></li>
                <li><a href="about.html">About</a></li>
            </ul>
        </div>
    </nav>

    <!-- Dashboard Section -->
    <section class="dashboard-section">
        <div class="container">
            <h1>üìä Feedback Dashboard</h1>
            
            <!-- Stats Cards -->
            <div class="dashboard-stats">
                <div class="stat-card">
                    <div class="stat-icon">üìù</div>
                    <div class="stat-info">
                        <h3 id="totalCount">0</h3>
                        <p>Total Feedbacks</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚≠ê</div>
                    <div class="stat-info">
                        <h3 id="avgRating">0.0</h3>
                        <p>Average Rating</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìÖ</div>
                    <div class="stat-info">
                        <h3 id="todayCount">0</h3>
                        <p>Today's Feedback</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üî•</div>
                    <div class="stat-info">
                        <h3 id="weekCount">0</h3>
                        <p>This Week</p>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="filters">
                <div class="filter-group">
                    <label for="categoryFilter">Filter by Category:</label>
                    <select id="categoryFilter">
                        <option value="">All Categories</option>
                        <option value="bug">Bug Report</option>
                        <option value="feature">Feature Request</option>
                        <option value="improvement">Improvement</option>
                        <option value="general">General Feedback</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="ratingFilter">Filter by Rating:</label>
                    <select id="ratingFilter">
                        <option value="">All Ratings</option>
                        <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5 stars)</option>
                        <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (4 stars)</option>
                        <option value="3">‚≠ê‚≠ê‚≠ê (3 stars)</option>
                        <option value="2">‚≠ê‚≠ê (2 stars)</option>
                        <option value="1">‚≠ê (1 star)</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="searchInput">Search:</label>
                    <input type="text" id="searchInput" placeholder="Search by name or message...">
                </div>
            </div>

            <!-- Feedback List -->
            <div class="feedback-dashboard">
                <h2>All Feedback</h2>
                <div id="feedbackList" class="feedback-grid">
                    <p class="loading">Loading feedbacks...</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 Cloud Feedback System | DevOps Final Exam Project</p>
        </div>
    </footer>

    <script src="app.js"></script>
    <script>
        let allFeedbacks = [];

        async function loadDashboard() {
            try {
                const response = await fetch('/api/feedbacks');
                allFeedbacks = await response.json();
                
                updateStats();
                displayFeedbacks(allFeedbacks);
            } catch (error) {
                document.getElementById('feedbackList').innerHTML = 
                    '<p class="error">Error loading feedbacks</p>';
            }
        }

        function updateStats() {
            const total = allFeedbacks.length;
            document.getElementById('totalCount').textContent = total;
            
            // Calculate average rating
            if (total > 0) {
                const avgRating = allFeedbacks.reduce((sum, f) => sum + (f.rating || 0), 0) / total;
                document.getElementById('avgRating').textContent = avgRating.toFixed(1);
            }
            
            // Today's count
            const today = new Date().toDateString();
            const todayCount = allFeedbacks.filter(f => 
                new Date(f.created_at).toDateString() === today
            ).length;
            document.getElementById('todayCount').textContent = todayCount;
            
            // This week's count
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            const weekCount = allFeedbacks.filter(f => 
                new Date(f.created_at) >= weekAgo
            ).length;
            document.getElementById('weekCount').textContent = weekCount;
        }

        function displayFeedbacks(feedbacks) {
            const container = document.getElementById('feedbackList');
            
            if (feedbacks.length === 0) {
                container.innerHTML = '<p class="no-data">No feedback found matching your filters.</p>';
                return;
            }
            
            container.innerHTML = feedbacks.map(feedback => {
                const stars = '‚≠ê'.repeat(feedback.rating || 0);
                const categoryEmoji = {
                    'bug': 'üêõ',
                    'feature': '‚ú®',
                    'improvement': 'üöÄ',
                    'general': 'üí¨',
                    'other': 'üìå'
                };
                
                return `
                    <div class="feedback-item-card">
                        <div class="feedback-item-header">
                            <div>
                                <h3>üë§ ${feedback.name}</h3>
                                ${feedback.email ? `<p class="email">üìß ${feedback.email}</p>` : ''}
                            </div>
                            <div class="feedback-meta">
                                <span class="category">${categoryEmoji[feedback.category] || 'üìå'} ${feedback.category || 'general'}</span>
                                <span class="rating">${stars}</span>
                            </div>
                        </div>
                        <div class="feedback-item-body">
                            <p>${feedback.message}</p>
                        </div>
                        <div class="feedback-item-footer">
                            <span class="date">üìÖ ${new Date(feedback.created_at).toLocaleString()}</span>
                            <button onclick="deleteFeedback('${feedback._id}')" class="btn-delete">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function deleteFeedback(id) {
            if (!confirm('Are you sure you want to delete this feedback?')) return;
            
            try {
                const response = await fetch(`/api/feedbacks/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    allFeedbacks = allFeedbacks.filter(f => f._id !== id);
                    updateStats();
                    displayFeedbacks(allFeedbacks);
                }
            } catch (error) {
                alert('Error deleting feedback');
            }
        }

        // Filters
        document.getElementById('categoryFilter').addEventListener('change', applyFilters);
        document.getElementById('ratingFilter').addEventListener('change', applyFilters);
        document.getElementById('searchInput').addEventListener('input', applyFilters);

        function applyFilters() {
            const category = document.getElementById('categoryFilter').value;
            const rating = document.getElementById('ratingFilter').value;
            const search = document.getElementById('searchInput').value.toLowerCase();
            
            let filtered = allFeedbacks;
            
            if (category) {
                filtered = filtered.filter(f => f.category === category);
            }
            
            if (rating) {
                filtered = filtered.filter(f => f.rating == rating);
            }
            
            if (search) {
                filtered = filtered.filter(f => 
                    f.name.toLowerCase().includes(search) || 
                    f.message.toLowerCase().includes(search)
                );
            }
            
            displayFeedbacks(filtered);
        }

        loadDashboard();
        
        // Auto-refresh every 30 seconds
        setInterval(loadDashboard, 30000);
    </script>
</body>
</html>